# CVE-2022-22965 – Spring4Shell RCE 재현 및 패치 검증

Spring Framework의 원격 코드 실행 취약점인 **CVE-2022-22965(Spring4Shell)** 을  
Docker 기반 Spring Boot 환경에서 직접 재현하고, 공격 성공 여부부터 패치 적용 이후 차단 효과까지  
전체 흐름을 실험한 분석 프로젝트입니다.

테스트 환경 구성 시에는 공개된 Spring4Shell 실험 레포지토리의 구조를 일부 참고하여  
취약 버전(Spring Boot 2.6.x + Embedded Tomcat)과 동일한 조건으로 설정했습니다.

---

## ✔ 1. 실험 환경 구성

테스트 환경은 아래와 같이 구성했습니다:

- Spring Boot **2.6.5**
- Spring Framework **5.3.17**
- OpenJDK **11.0.14.1**
- Tomcat (embedded)
- Docker 기반 컨테이너 실행

컨테이너 기동 시 출력되는 Spring Boot 배너:

![spring boot banner](images/springboot-banner.png)

---

## ✔ 2. 실제 Spring / Java 버전 검증

컨테이너 내부에서 Java 버전을 확인한 결과:

openjdk version "11.0.14.1"
OpenJDK Runtime Environment 18.9


![java version](images/java-version.png)

Spring 라이브러리 목록:

spring-aop-5.3.17.jar
spring-beans-5.3.17.jar
spring-core-5.3.17.jar
spring-webmvc-5.3.17.jar
spring-boot-2.6.5.jar


![spring libs](images/spring-libs.png)

`pom.xml` 설정(취약 버전 확인):

![pom xml](images/pom-version.png)

---

## ✔ 3. Docker 애플리케이션 실행 상태

컨테이너가 정상적으로 올라온 상태:

CONTAINER ID IMAGE COMMAND PORTS
xxxxx spring4shell "catalina.sh run" 0.0.0.0:9090->8080/tcp


![docker ps](images/docker-ps.png)

---

## ✔ 4. Spring4Shell PoC 공격 수행

Spring4Shell 공격은 WebDataBinder가 처리하는 property path를 조작하여  
**Tomcat AccessLogValve 설정을 내 마음대로 덮어쓰는 방식**으로 수행된다.

PoC 구조는 아래와 같다 (IP 제거됨):

curl -X POST http://[TARGET]/demo/itsecurityco
-H "Content-Type: application/x-www-form-urlencoded"
--data-urlencode "class.module.classLoader.resources.context.parent.pipeline.first.pattern=..."


![poc request](images/poc-request.png)

요청 결과는 WhiteLabel Error Page 형태지만  
이 시점에서 **내부적으로 AccessLogValve override가 이미 수행된 상태**이다.

---

## ✔ 5. JSP 웹셸 생성 확인

공격이 성공했다면 Tomcat ROOT 디렉토리에 `shell.jsp`가 생성된다.

docker exec -it spring4shell ls /usr/local/tomcat/webapps/ROOT
shell.jsp


![shell jsp generated](images/shelljsp-generated.png)

생성된 JSP 웹셸 내용 확인:

![shell jsp content](images/shelljsp-content.png)

해당 JSP는 요청 파라미터 `cmd` 값을 OS 명령으로 실행하고 그 결과를 출력한다.

---

## ✔ 6. RCE 수행 결과 (성공)

웹셸을 통해 OS 명령 실행 테스트:

curl "http://[TARGET]/shell.jsp?cmd=id"


반환 결과:

uid=0(root) gid=0(root) groups=0(root)


![rce id result](images/rce-id-result.png)

→ **root 권한 명령 실행 성공 → RCE 완벽하게 재현됨**

---

## ✔ 7. 패치 적용 후 재공격 테스트 (차단됨)

Spring 공식 가이드에 따라 WebDataBinder 위험 필드 접근을 차단하기 위해  
다음과 같은 코드를 적용:

```java
@ControllerAdvice
public class GlobalBindingConfig {

    @InitBinder
    public void configureBinding(WebDataBinder binder) {
        binder.setDisallowedFields(
                "class.*",
                "Class.*",
                "module.*",
                "classLoader.*",
                "*.classLoader",
                "*.module",
                "*.class"
        );
    }
}
```
---
이후 동일 PoC 재수행:

JSP 생성 실패 및 404 응답:

결과:

JSP 생성 불가

AccessLogValve override 차단

RCE 재현 불가

→ 패치 적용 시 취약점이 완전히 차단됨을 확인

---
## 8. 최종 결론

취약 버전(Spring Boot 2.6.5 / Spring 5.3.17)에서는
PoC 기반 웹셸 생성 → root 권한 RCE까지 확인됨

패치 적용 시
AccessLogValve override 완전 차단 → JSP 생성 불가 → RCE 불가

즉, Spring4Shell은 특정 조건에서 즉시 RCE로 이어지는 고위험 취약점이며,
Spring Framework 패치 및 WebDataBinder 기반 필드 차단 설정이
실질적인 대응책임을 확인했습니다.



